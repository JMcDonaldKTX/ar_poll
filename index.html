<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>AR Poll - Scan & Vote</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
  <style>
    body { margin: 0; overflow: hidden; font-family: sans-serif; }
    #ui { position: absolute; top: 20px; left: 0; width: 100%; text-align: center; color: white; z-index: 10; background: rgba(0,0,0,0.5); padding: 10px; }
    button { padding: 12px 24px; font-size: 18px; background: #007AFF; color: white; border: none; border-radius: 8px; cursor: pointer; }
    #status { color: #FF3B30; font-size: 14px; margin: 10px 0; }
  </style>
  <!-- AR.js + A-Frame -->
  <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
  <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar-nft.js"></script>
</head>
<body>
  <div id="ui">
    <h2 id="question">What's your favorite game character?</h2>
    <button id="start-ar">Start AR Poll</button>
    <div id="status"></div>
  </div>

  <a-scene embedded arjs="sourceType: webcam; detectionMode: mono_and_matrix; matrixCodeType: bch; debugUIEnabled: false;">
    <!-- Camera -->
    <a-entity camera></a-entity>

    <!-- NFT (Natural Feature Tracking) for markerless surface detection -->
    <a-nft type="nft" url="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mP8/5+hHgAHggJ/PchI7wAAAABJRU5ErkJggg=="></a-nft> <!-- Placeholder NFT dataset; generate custom for better tracking -->

    <!-- Options will be placed here on detection -->
  </a-scene>

  <script>
    const startBtn = document.getElementById('start-ar');
    const status = document.getElementById('status');
    const scene = document.querySelector('a-scene');
    const nft = document.querySelector('a-nft');

    // Poll data (add your media paths)
    const pollData = {
      question: "What's your favorite game character?",
      options: [
        { text: "Mario", media: "mario.png", type: "image" },
        { text: "Link", media: "link.gif", type: "gif" },
        { text: "Pikachu", media: "pikachu.mp4", type: "video" }
      ]
    };

    startBtn.addEventListener('click', () => {
      startBtn.style.display = 'none';
      status.textContent = 'Detecting surface... Point at a flat area (table/floor).';
      scene.setAttribute('visible', true);

      // Place options on first NFT detection (surface found)
      nft.addEventListener('loaded', () => {
        placeOptions();
        status.textContent = 'Options anchored! Tap to vote.';
        setTimeout(() => status.textContent = '', 3000);
      });
    });

    function placeOptions() {
      pollData.options.forEach((option, index) => {
        let entity;
        if (option.type === 'image' || option.type === 'gif') {
          entity = document.createElement('a-plane');
          entity.setAttribute('material', `src: ${option.media}; transparent: true; repeat: 1 1`);
          entity.setAttribute('width', 0.8);
          entity.setAttribute('height', 0.8);
        } else if (option.type === 'video') {
          entity = document.createElement('a-video');
          entity.setAttribute('src', option.media);
          entity.setAttribute('width', 0.8);
          entity.setAttribute('height', 0.8);
          entity.setAttribute('autoplay', true);
          entity.setAttribute('loop', true);
        }

        // Anchor to NFT (surface); space horizontally
        entity.setAttribute('position', `${(index - 1) * 1.0} 0.5 0`);
        entity.setAttribute('look-at', '[camera]'); // Face user

        // Label
        const text = document.createElement('a-text');
        text.setAttribute('value', option.text);
        text.setAttribute('position', '0 -0.5 0');
        text.setAttribute('align', 'center');
        text.setAttribute('color', 'black');
        entity.appendChild(text);

        // Vote on tap
        entity.addEventListener('click', () => {
          alert(`Voted for ${option.text}!`);
          // Optional: fetch('/vote', { method: 'POST', body: JSON.stringify({ vote: option.text }) });
        });

        nft.appendChild(entity);
      });
    }
  </script>
</body>
</html>
